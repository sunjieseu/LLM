<!DOCTYPE html>
<html>
<head>
    <title>访客统计调试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .stats { background: #f0f0f0; padding: 15px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #000; color: #0f0; padding: 10px; font-family: monospace; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>访客统计调试工具</h1>
    
    <div class="stats">
        <h3>当前统计</h3>
        <p>访客数: <span id="visitors">-</span></p>
        <p>浏览量: <span id="views">-</span></p>
        <p>状态: <span id="status">未初始化</span></p>
    </div>
    
    <div>
        <button onclick="runTest()">运行测试</button>
        <button onclick="clearData()">清除数据</button>
        <button onclick="showData()">显示原始数据</button>
        <button onclick="simulateVisits()">模拟多次访问</button>
    </div>
    
    <div class="log" id="log"></div>
    
    <script>
        function log(message) {
            const logDiv = document.getElementById('log')
            logDiv.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n'
            logDiv.scrollTop = logDiv.scrollHeight
        }
        
        function updateLocalStats() {
            try {
                log('开始更新本地统计...')
                
                const getFingerprint = () => {
                    const canvas = document.createElement('canvas')
                    const ctx = canvas.getContext('2d')
                    if (ctx) {
                        ctx.textBaseline = 'top'
                        ctx.font = '14px Arial'
                        ctx.fillText('Browser fingerprint', 2, 2)
                        return canvas.toDataURL().slice(-50)
                    }
                    return btoa(
                        navigator.userAgent + 
                        screen.width + 'x' + screen.height + 
                        new Date().getTimezoneOffset()
                    ).slice(-20)
                }

                const fingerprint = getFingerprint()
                const today = new Date().toISOString().split('T')[0]
                
                log('指纹: ' + fingerprint.slice(-10))
                log('日期: ' + today)
                
                const statsData = JSON.parse(localStorage.getItem('realStatsData') || '{"visitors": [], "views": 0, "lastUpdate": "", "dailyVisitors": {}}')
                
                log('当前数据: 访客' + statsData.visitors.length + ', 浏览' + statsData.views)
                
                statsData.views = (statsData.views || 0) + 1
                
                const visitorKey = `${fingerprint}_${today}`
                let isNewVisitor = false
                
                if (!statsData.visitors.includes(visitorKey)) {
                    statsData.visitors.push(visitorKey)
                    isNewVisitor = true
                    log('检测到新访客!')
                } else {
                    log('重复访客')
                }
                
                statsData.lastUpdate = new Date().toISOString()
                localStorage.setItem('realStatsData', JSON.stringify(statsData))
                
                const result = {
                    visitorCount: statsData.visitors.length,
                    pageViews: statsData.views
                }
                
                log('更新后: 访客' + result.visitorCount + ', 浏览' + result.pageViews)
                
                return result
            } catch (error) {
                log('错误: ' + error.message)
                return { visitorCount: 1, pageViews: 1 }
            }
        }
        
        function runTest() {
            document.getElementById('status').textContent = '测试中...'
            log('=== 开始测试 ===')
            
            const stats = updateLocalStats()
            
            document.getElementById('visitors').textContent = stats.visitorCount
            document.getElementById('views').textContent = stats.pageViews
            document.getElementById('status').textContent = '测试完成'
            
            log('=== 测试完成 ===')
        }
        
        function clearData() {
            localStorage.removeItem('realStatsData')
            log('数据已清除')
            document.getElementById('visitors').textContent = '-'
            document.getElementById('views').textContent = '-'
            document.getElementById('status').textContent = '数据已清除'
        }
        
        function showData() {
            const data = localStorage.getItem('realStatsData')
            if (data) {
                log('原始数据: ' + data)
                const parsed = JSON.parse(data)
                log('解析数据: 访客数组长度=' + parsed.visitors.length + ', 浏览量=' + parsed.views)
            } else {
                log('没有存储数据')
            }
        }
        
        function simulateVisits() {
            log('=== 模拟5次访问 ===')
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const stats = updateLocalStats()
                    document.getElementById('visitors').textContent = stats.visitorCount
                    document.getElementById('views').textContent = stats.pageViews
                }, i * 500)
            }
        }
        
        // 页面加载时运行一次测试
        window.onload = () => {
            log('页面加载完成，运行初始测试')
            runTest()
        }
    </script>
</body>
</html>